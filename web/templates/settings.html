<!-- FINAL VERSION OF templates/settings.html (no invoice-import panel) -->
{% extends "base.html" %}
{% set title = "Settings — Remind & Pay" %}
{% block content %}
<link rel="stylesheet" href="/static/css/settings.css">

<h1>Settings</h1>

<nav id="set_tabs" class="tabbar" style="margin:0 0 12px 0;">
  <button class="tab is-active" data-tab="app">App settings</button>
  <button class="tab" data-tab="email">Email settings</button>
  <button class="tab" data-tab="sms">SMS settings</button>
  <button class="tab" data-tab="import">Invoice import</button>
  <button class="tab" data-tab="restore">Restore defaults</button>
  <div style="flex:1"></div>
  <a
    id="sms_balance_chip"
    href="/schedule"
    class="btn btn--ghost"
    style="display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 12px;"
    title="Open SMS activity"
    aria-label="SMS balance"
  >
    SMS balance: Enable
  </a>
  <a class="btn btn--ghost" href="mailto:support@remindandpay.com">Support</a>
</nav>

<!-- APP SETTINGS TAB -->
<section id="tab_app">
  <section class="panel" style="max-width:1100px; margin-top:12px;">
    <div class="panel__head"><h2>Time & date</h2></div>
    <div class="content" style="padding:12px;">
      <div class="grid" style="grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px; align-items:end;">
        <div class="field">
          <label>Date format</label>
          <select id="set_date" style="height:36px;padding:0 8px;">
            <option value="en-GB">UK (dd/mm/yyyy)</option>
            <option value="en-US">US (mm/dd/yyyy)</option>
          </select>
        </div>
        <div class="field">
          <label>Time format</label>
          <select id="set_time" style="height:36px;padding:0 8px;">
            <option value="24h">24-hour</option>
            <option value="12h">12-hour</option>
          </select>
        </div>
        <div class="field">
          <label>Time zone</label>
          <select id="set_tz" style="height:36px;padding:0 8px;max-width:420px;">
            <option value="UTC">Loading…</option>
          </select>
        </div>
        <div class="field">
          <label>Default send time</label>
          <input id="set_send_time" type="time" step="60" style="height:36px;padding:0 8px;" value="14:00">
        </div>
      </div>
    </div>
  </section>

  <section class="panel" style="max-width:1100px; margin-top:12px;">
    <div class="panel__head"><h2>Company details</h2></div>
    <div class="content" style="padding:12px;">
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
        <div class="field">
          <label>Organisation address (printed on statements)</label>
          <textarea id="set_org_addr" rows="5" style="width:100%;padding:8px;"></textarea>
        </div>
        <div class="field">
          <label>Logo</label>
          <img id="set_logo_preview" alt="Logo" style="display:none; max-width:240px; max-height:120px; object-fit:contain; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
          <div class="field-row" style="gap:8px; margin-top:8px;">
            <input id="set_logo_input" type="file" accept="image/*">
            <button id="set_logo_remove" type="button" class="btn btn--ghost">Remove</button>
          </div>
          <div id="set_logo_msg" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="panel" style="max-width:1100px; margin-top:12px;">
    <div class="panel__head"><h2>Currency & region</h2></div>
    <div class="content" style="padding:12px;">
      <div class="grid" style="grid-template-columns:repeat(2,minmax(220px,1fr)); gap:12px;">
        <div class="field">
          <label>Default country</label>
          <select id="set_country" style="height:36px;padding:0 8px;">
            <option value="GB">United Kingdom</option>
            <option value="US">United States</option>
            <option value="EU">European Union</option>
          </select>
        </div>
        <div class="field">
          <label>Currency</label>
          <select id="set_currency" style="height:36px;padding:0 8px;">
            <option value="GBP">GBP (£)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (€)</option>
          </select>
          <div class="muted" style="margin-top:4px;">Note: currency selection is for UI only for now.</div>
        </div>
      </div>
    </div>
  </section>

  <section class="panel" style="max-width:1100px; margin-top:12px;">
    <div class="panel__head"><h2>Colour scheme</h2></div>
    <div class="content" style="padding:12px;">
      <div class="field-row" style="gap:8px; flex-wrap:wrap;">
        <label class="chip"><input type="radio" name="theme" value="default" checked><span style="margin-left:6px;">Default</span></label>
        <label class="chip"><input type="radio" name="theme" value="teal"><span style="margin-left:6px;">Teal</span></label>
        <label class="chip"><input type="radio" name="theme" value="indigo"><span style="margin-left:6px;">Indigo</span></label>
        <label class="chip"><input type="radio" name="theme" value="purple"><span style="margin-left:6px;">Purple</span></label>
        <label class="chip"><input type="radio" name="theme" value="blue"><span style="margin-left:6px;">Blue</span></label>
        <label class="chip"><input type="radio" name="theme" value="orange"><span style="margin-left:6px;">Orange</span></label>
        <label class="chip"><input type="radio" name="theme" value="rose"><span style="margin-left:6px;">Rose</span></label>
        <label class="chip"><input type="radio" name="theme" value="emerald"><span style="margin-left:6px;">Emerald</span></label>
        <label class="chip"><input type="radio" name="theme" value="slate"><span style="margin-left:6px;">Slate</span></label>
        <label class="chip"><input type="radio" name="theme" value="custom"><span style="margin-left:6px;">Custom</span></label>
      </div>

      <div class="field" style="margin-top:12px; max-width:260px;">
        <label>Custom brand colour</label>
        <input id="set_brand_color" type="color" value="#6366f1" style="height:36px; width:100%; padding:0 8px;" disabled>
        <div class="muted" style="margin-top:4px;">Used only if "Custom" is selected. Applies to buttons, accents, and headings.</div>
      </div>

      <div class="muted" style="margin-top:6px;">Changes are applied immediately in this browser and saved to your account.</div>

      <div class="field-row" style="gap:8px; align-items:center; margin-top:12px;">
        <button id="set_save" class="btn">Save all settings</button>
        <span id="set_msg" class="muted"></span>
      </div>
    </div>
  </section>
</section>

<!-- EMAIL SETTINGS TAB -->
<section id="tab_email" class="panel" style="max-width:900px; margin-top:12px; display:none;">
  <div class="panel__head"><h2>Email delivery</h2></div>
  <div class="content" style="padding:12px;">
    <div class="grid" style="gap:12px;">

      <div class="muted">Choose an approved sender. Add your own domain to appear here once verified.</div>

      <!-- Approved senders -->
      <div class="subpanel" style="padding:12px; border:1px solid #eee; border-radius:8px;">
        <h3 style="margin:0 0 10px 0; font-size:16px;">Approved senders</h3>

        <div class="field" style="max-width:420px;">
          <label>Default From name</label>
          <input id="em_from_name" placeholder="Remind &amp; Pay" style="height:36px;padding:0 10px;">
          <div id="em_msg" class="muted" style="margin-top:6px;"></div>
        </div>

        <div id="sender_list" class="grid" style="margin-top:12px; gap:8px;">
          <!-- Platform option -->
          <label class="cardlike" style="display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #eee; border-radius:10px;">
            <input type="radio" name="sender_choice" value="platform" data-email="accounts@remindandpay.com">
            <div>
              <div><strong>Remind &amp; Pay platform</strong></div>
              <div class="muted">From: <code>accounts@remindandpay.com</code></div>
            </div>
          </label>

          <!-- Verified domains mount -->
          <div id="sender_verified_mount"></div>
        </div>
      </div>

      <!-- Domain wizard entry -->
      <div class="field-row" style="gap:10px; align-items:center; margin-top:6px;">
        <button id="btn_open_domain_wizard" class="btn btn--subtle">Send from your own domain…</button>
        <span class="muted">Set up DKIM and Return-Path via Postmark.</span>
      </div>

      <!-- Send test -->
      <div class="field-row" style="margin-top:8px;gap:8px;">
        <input id="email_test_to" type="email" placeholder="Send test to…" style="height:36px;padding:0 8px;flex:0 0 320px;">
        <button id="email_test_send" class="btn btn--subtle">Send test</button>
        <span id="email_test_msg" class="muted"></span>
      </div>
    </div>
  </div>
</section>

<!-- SMS SETTINGS TAB -->
<section id="tab_sms" class="panel" style="max-width:900px; margin-top:12px; display:none;">
  <div class="panel__head"><h2>SMS delivery (Twilio)</h2></div>
  <div class="content" style="padding:12px;">
    <div class="grid" style="gap:14px;">
      <div class="muted">
        SMS is off by default. When enabled, reminders can be sent via your
        dedicated Twilio number. You can also forward replies to a mobile number.
      </div>

      <div class="subpanel" style="padding:12px; border:1px solid #eee; border-radius:8px;">
        <h3 style="margin:0 0 10px 0; font-size:16px;">SMS status</h3>
        <div class="grid" style="grid-template-columns:repeat(2,minmax(240px,1fr)); gap:12px; align-items:end;">
          <div class="field">
            <label>SMS enabled</label>
            <select id="sms_enabled" style="height:36px;padding:0 8px;">
              <option value="false">Off</option>
              <option value="true">On</option>
            </select>
            <div id="sms_enabled_hint" class="muted" style="margin-top:4px;"></div>
          </div>
          <div class="muted" style="padding-bottom:6px;">
            Your SMS balance is shown in the header and opens SMS activity.
          </div>
        </div>
        <input id="sms_bundle_size" type="number" min="100" step="100" value="1000" style="display:none;">
        <input id="sms_credits" type="number" min="0" step="1" value="0" style="display:none;" disabled>
      </div>

      <div class="subpanel" style="padding:12px; border:1px solid #eee; border-radius:8px;">
        <h3 style="margin:0 0 10px 0; font-size:16px;">Dedicated number</h3>
        <div class="grid" style="grid-template-columns:repeat(2,minmax(240px,1fr)); gap:12px;">
          <div class="field">
            <label>Twilio phone number</label>
            <input id="sms_phone_number" placeholder="+44..." style="height:36px;padding:0 8px;" disabled>
            <div class="muted" style="margin-top:4px;">Provisioned automatically when SMS is enabled.</div>
          </div>
          <div class="field">
            <label>Twilio phone SID</label>
            <input id="sms_phone_sid" placeholder="PNxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="height:36px;padding:0 8px;" disabled>
          </div>
        </div>
      </div>

      <div class="subpanel" style="padding:12px; border:1px solid #eee; border-radius:8px;">
        <h3 style="margin:0 0 10px 0; font-size:16px;">Reply forwarding</h3>
        <div class="grid" style="grid-template-columns:repeat(2,minmax(240px,1fr)); gap:12px;">
          <div class="field">
            <label>Forward replies</label>
            <select id="sms_forwarding_enabled" style="height:36px;padding:0 8px;">
              <option value="false">Off</option>
              <option value="true">On</option>
            </select>
          </div>
          <div class="field">
            <label>Forward to mobile</label>
            <input id="sms_forward_to" placeholder="+44..." style="height:36px;padding:0 8px;">
            <div class="muted" style="margin-top:4px;">Replies will also appear in SMS activity.</div>
          </div>
        </div>
      </div>

      <div class="field-row" style="gap:8px; align-items:center; margin-top:8px;">
        <button id="sms_save" class="btn">Save SMS settings</button>
        <span id="sms_msg" class="muted"></span>
      </div>
    </div>
  </div>
</section>

<div id="sms_enable_modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1000;">
  <div style="background:#fff; width:700px; max-width:90vw; margin:60px auto; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <div style="padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; font-size:18px;">Enable SMS</h3>
      <button id="sms_enable_close" class="btn btn--ghost">Close</button>
    </div>
    <div style="padding:16px;">
      <p class="muted" style="margin-top:0;">Before you continue, review the SMS pricing and terms below.</p>
      <ul id="sms_enable_terms" class="muted" style="margin:0 0 12px 18px; line-height:1.6;">
        <li>Loading pricing…</li>
      </ul>
      <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
        <input type="checkbox" id="sms_enable_accept">
        I accept these SMS terms and pricing.
      </label>
      <div class="field-row" style="gap:8px; align-items:center; margin-top:14px;">
        <button id="sms_enable_confirm" class="btn">Enable SMS</button>
        <button id="sms_enable_cancel" class="btn btn--ghost">Cancel</button>
        <span id="sms_enable_msg" class="muted"></span>
      </div>
    </div>
  </div>
</div>

<!-- RESTORE DEFAULTS TAB -->
<section id="tab_restore" class="panel" style="max-width:820px; margin-top:12px; display:none;">
  <div class="panel__head"><h2>Restore defaults</h2></div>
  <div class="content" style="padding:12px;">
    <p class="muted">This will restore default statement rules and message templates for your account. Use with caution — your custom templates will be overwritten.</p>
    <div class="field-row" style="gap:8px; align-items:center; margin-top:8px;">
      <button id="set_restore_defaults" class="btn btn--ghost danger">Restore defaults</button>
      <span id="set_restore_msg" class="muted"></span>
    </div>
  </div>
</section>

<!-- Domain wizard modal (verify-only) -->
<div id="domain_wizard_modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1000;">
  <div style="background:#fff; width:820px; max-width:90vw; margin:60px auto; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <div style="padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; font-size:18px;">Use your own domain</h3>
      <button id="dw_close" class="btn btn--ghost">Close</button>
    </div>

    <div style="padding:16px;">
      <!-- Step 1: enter domain -->
      <div id="dw_step1">
        <p class="muted">Enter the domain you own (e.g. <code>example.com</code>). We’ll generate DKIM and Return-Path records.</p>
        <div class="field-row" style="gap:8px;">
          <input id="dw_domain" placeholder="example.com" style="height:36px; padding:0 10px; flex:1;">
          <button id="dw_start" class="btn">Start</button>
          <span id="dw_msg" class="muted"></span>
        </div>
      </div>

      <!-- Step 2: show DNS -->
      <div id="dw_step2" style="display:none;">
        <div id="dw_dns_block"></div>
        <div class="muted" style="margin-top:8px;">Add these DNS records at your DNS provider. When done, click Verify.</div>

        <div class="field-row" style="gap:8px; margin-top:10px;">
          <button id="dw_verify" class="btn">Verify</button>
          <button id="dw_delete" class="btn btn--ghost danger" type="button" title="Remove this domain from your account and Postmark">Remove</button>
          <span id="dw_verify_msg" class="muted"></span>
        </div>

        <div class="muted" id="dw_verified_hint" style="display:none; margin-top:10px;">
          Verified ✔ — close this window. Your domain now appears in “Approved senders”.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="/static/js/settings.js"></script>
<script src="/static/js/email_settings_ui.js"></script>
<script src="/static/js/sms_settings.js"></script>

<script>
  // INLINE TAB SWITCHER ON /settings (Invoice import redirects to separate page)
  (function(){
    const tabs = document.getElementById('set_tabs');
    if (!tabs) return;

    const app     = document.getElementById('tab_app');
    const email   = document.getElementById('tab_email');
    const sms     = document.getElementById('tab_sms');
    const restore = document.getElementById('tab_restore');

    function showOnly(which) {
      if (!app || !email || !sms || !restore) return;
      app.style.display     = (which === 'app')     ? 'block' : 'none';
      email.style.display   = (which === 'email')   ? 'block' : 'none';
      sms.style.display     = (which === 'sms')     ? 'block' : 'none';
      restore.style.display = (which === 'restore') ? 'block' : 'none';
    }

    // default
    showOnly('app');

    tabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab');
      if (!btn) return;
      const which = btn.dataset.tab;

      // highlight tab
      tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('is-active'));
      btn.classList.add('is-active');

      if (which === 'import') {
        window.location.href = '/settings/invoice-import';
        return;
      }

      if (which === 'email') {
        showOnly('email');
        window.dispatchEvent(new Event('email_settings_tab_activated'));
      } else if (which === 'sms') {
        showOnly('sms');
        window.dispatchEvent(new Event('sms_settings_tab_activated'));
      } else if (which === 'restore') {
        showOnly('restore');
      } else {
        showOnly('app');
      }
    });
  })();
</script>

{% endblock %}
